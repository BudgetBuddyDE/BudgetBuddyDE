---
title: Backend
---

![CI](https://ci.tklein.it/api/v1/teams/budgetbuddyde/pipelines/backend/jobs/build-backend/badge)
![CI-API-SCHEMAS](https://ci.tklein.it/api/v1/teams/budgetbuddyde/pipelines/backend/jobs/test-api-schemas/badge)

## About

The backend was developed using the SAP Capire Framework and PostgreSQL for persistence, enabling the frontend application to access and manage data. It provides a RESTful API in OData format, which allows data to be created, read, updated, and deleted (CRUD operations). The backend has a modular structure and can be easily expanded to add additional functions.
Data security was ensured with restriction rules and the Auth service, which is responsible for user authentication and authorization, ensuring that each user can only access their own data.

## Getting started

### Development

<Steps>
<Step>
#### Clone the repository
    
```bash
git clone git@github.com:budgetbuddyde/budgetbuddyde.git
```

</Step>
<Step>
#### Install dependencies

```bash
npm install
```

</Step>
<Step>
#### Change to the backend directory

```bash
cd ./services/backend
```

</Step>
<Step>
#### Set up environment variables
    
Set all required environment variables as defined in the `.env.example` file. You can copy the example file to create your own `.env` file.
</Step>
<Step>
#### Start the application

```bash
npm run watch
```

</Step>
</Steps>

## Build

### For Docker

<Callout type="info">
  A current Docker image is automatically created when a commit is pushed to the `main` branch. The
  image is provided in the GitHub Container Registry under `ghcr.io/budgetbuddyde/backend:latest`.
</Callout>

To build the service for Docker, you can use the following command:

```bash
docker build \
  --build-arg DB_HOST=mein-db-host \
  --build-arg DB_PORT=5432 \
  --build-arg DB_USER=meinuser \
  --build-arg DB_PASSWORD=geheim \
  --build-arg DB_DATABASE=meinedb \
  -t ghcr.io/budgetbuddyde/backend:latest .
```

## Deployment

The service is currently provided automatically as soon as a commit is pushed to the `main` branch. The service is run in a Docker container and provided in a Railway environment.

> [!IMPORTANT]
> The service is deployed using a Docker image. To establish the database connection within the Docker container, the `.cdsrc` must be generated during the build process and filled with the connection information for the Postres instance.
> Learn more at [SAP Capire Postgres Deployment](https://cap.cloud.sap/docs/guides/databases-postgres#deployment)

### Schema Migration

Information about the restrictions that apply to automatic schema evolution can be found in the [SAP Capire documentation](https://cap.cloud.sap/docs/guides/databases-postgres#schema-evolution).

### Environment Variables

#### Database Configuration

> [!NOTE]
> These environment variables are only required to be set during the build-process as these will be used to generate the `.cdsrc`-file for the instance.

- `DB_HOST`: The hostname of the PostgreSQL database.
- `DB_PORT`: The port number of the PostgreSQL database.
- `DB_USER`: The username for the PostgreSQL database.
- `DB_PASSWORD`: The password for the PostgreSQL database.
- `DB_DATABASE`: The name of the PostgreSQL database.

#### `REDIS_URL`

The URL of the Redis instance used for caching and session management. Example:

```txt
REDIS_URL=redis://default:password@redis-host:6379
```

#### `AUTH_SERVICE_HOST`

The host URL of the authentication service. Example:

```txt
AUTH_SERVICE_HOST=https://auth.example.com
```

#### `ORIGINS`

A comma-separated list of allowed origins for CORS and trusted origins for authentication. Example:

```txt
ORIGINS=https://next.app.budget-buddy.de,https://next.backend.budget-buddy.de
```

#### `METAL_API_KEY`

API key for [metalpriceapi.com](https://metalpriceapi.com/), used for retrieving metal prices. Example:

```txt
METAL_API_KEY=your_api_key_here
```

## Security

<Callout>
  The backend is secured by the Auth Service, which ensures that only authenticated users can access
  the data (by using `@(restrict: [])`; [SAP Capire
  documentation](https://cap.cloud.sap/docs/guides/security/authorization#restrictions)).
</Callout>

The middleware for authentication was implemented in `srv/auth.ts`. For testing purposes, authentication is mocked and a user is set in `srv/mocked-test.ts`.

## Credits

- [SAP Capire Framework](https://cap.cloud.sap)
- [PostgreSQL](https://www.postgresql.org)
