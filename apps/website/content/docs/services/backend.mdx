---
title: Backend
---

![CI](https://ci.tklein.it/api/v1/teams/budgetbuddyde/pipelines/backend/jobs/build-new-backend/badge)

## About

The backend was developed using ExpressJS and Drizzle ORM for persistence, enabling the frontend application to access and manage data. It provides a RESTful API, which allows data to be created, read, updated, and deleted (CRUD operations). The backend has a modular structure and can be easily expanded to add additional functions.
Data security was ensured with restriction rules and the Auth service, which is responsible for user authentication and authorization, ensuring that each user can only access their own data.

## Getting started

### Development

<Steps>
<Step>
#### Clone the repository

```bash
git clone git@github.com:budgetbuddyde/budgetbuddyde.git
```

</Step>
<Step>
#### Install dependencies

```bash
npm install
```

</Step>
<Step>
#### Change to the backend directory

```bash
cd ./services/backend
```

</Step>
<Step>
#### Set up environment variables

Set all required environment variables as defined in the `.env.example` file. You can copy the example file to create your own `.env` file.

```bash
cp .env.example .env
```
</Step>
<Step>
#### Start the application

```bash
npm run watch
```

</Step>
</Steps>

## Build

### For Docker

<Callout type="info">
  A current Docker image is automatically created when a commit is pushed to the `main` branch. The
  image is provided in the GitHub Container Registry under `ghcr.io/budgetbuddyde/backend:latest`.
</Callout>

To build the service for Docker, you can use the following command:

```bash
docker build \
  --build-arg DB_HOST=mein-db-host \
  --build-arg DB_PORT=5432 \
  --build-arg DB_USER=meinuser \
  --build-arg DB_PASSWORD=geheim \
  --build-arg DB_DATABASE=meinedb \
  -t ghcr.io/budgetbuddyde/backend:latest .
```

## Deployment

The service is currently provided automatically as soon as a commit is pushed to the `main` branch. The service is run in a Docker container and provided in a Railway environment.

### Schema Migration

<Callout type="info">
  The backend uses Drizzle ORM for database migrations. More information on schema migration can be found in [the documentation](https://orm.drizzle.team/docs/kit-overview) of Drizzle ORM.
</Callout>

1. Generate migration SQL files using Drizzle ORM.

   ```bash
   npm run db:generate
   ```

2. Apply the generated migration files to your PostgreSQL database.

   ```bash
   npm run db:migrate
   ```

Now your database schema should be up-to-date with the application's requirements.

## Jobs

### `process-recurring-payments`

This job processes all due recurring payments and creates corresponding transactions. It is scheduled to run daily at 01:30 AM in the configured timezone.

## Environment Variables

### `NODE_ENV`

The `NODE_ENV` environment variable defines the execution environment of the backend. Possible values are `development`, `production`, and `test`. By default, the value is set to `development`. To ensure correct behavior in production environments, this variable should be set to `production`.

### `DATABASE_URL`

The connection string for the PostgreSQL database.

### `REDIS_URL`

The connection string for the Redis cache.

#### `REDIS_DB`

The index of the Redis database to use. If not set, it defaults to `1`.

### `AUTH_SERVICE_HOST`

The base URL of the authentication service. If not set, it defaults to `http://localhost:8080`.

### `TRUSTED_ORIGINS`

A comma-separated list of trusted origins that are allowed to make CORS requests to the backend.

### `PORT`

The `PORT` environment variable defines the port on which the backend server listens. If the variable is not explicitly set, port `9000` is used by default.

### `LOG_LEVEL`

The `LOG_LEVEL` environment variable determines the level of detail for logging in the backend. Possible values are: `DEBUG`, `INFO`, `WARN`, `ERROR`, and `FATAL`. By default, the value is set to `INFO`.

### `TIMEZONE`

The `TIMEZONE` environment variable defines the time zone used for time-related operations in the backend (e.g., for scheduling jobs). By default, the time zone is set to `Europe/Berlin`.

#### `REDIS_URL`

The URL of the Redis instance used for caching and session management. Example:

```txt
REDIS_URL=redis://default:password@redis-host:6379
```

#### `AUTH_SERVICE_HOST`

The host URL of the authentication service. Example:

```txt
AUTH_SERVICE_HOST=https://auth.example.com
```

#### `ORIGINS`

A comma-separated list of allowed origins for CORS and trusted origins for authentication. Example:

```txt
ORIGINS=https://next.app.budget-buddy.de,https://next.backend.budget-buddy.de
```

#### `METAL_API_KEY`

API key for [metalpriceapi.com](https://metalpriceapi.com/), used for retrieving metal prices. Example:

```txt
METAL_API_KEY=your_api_key_here
```

## Security

<Callout>
  The backend is secured by the Auth Service, which ensures that only authenticated users can access
  the data (by using `@(restrict: [])`; [SAP Capire
  documentation](https://cap.cloud.sap/docs/guides/security/authorization#restrictions)).
</Callout>

The middleware for authentication was implemented in `srv/auth.ts`. For testing purposes, authentication is mocked and a user is set in `srv/mocked-test.ts`.

## Credits

- [SAP Capire Framework](https://cap.cloud.sap)
- [PostgreSQL](https://www.postgresql.org)
