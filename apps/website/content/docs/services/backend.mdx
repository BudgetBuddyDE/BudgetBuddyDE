---
title: Backend
description: The Backend is the central component of the web application and provides the API as well as the business logic.
---

## Overview

<div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
  {[
    {
      url: "https://ci.tklein.it/api/v1/teams/budgetbuddyde/pipelines/backend/jobs/build-backend/badge?title=Build",
      alt: "CI Build Status"
    },
    {
      url: "https://img.shields.io/github/v/tag/budgetbuddyde/budgetbuddyde?filter=backend*&cacheSeconds=3600",
      alt: "Version"
    }
  ].map(({url, alt}) => (
    <img 
      src={url}
      alt={alt}
      unoptimized="true"
      style={{marginBottom: '0', marginTop: '0'}}
    />
  ))}
</div>

The Backend is based on Node.js with the Express.js Framework and is written in TypeScript. It provides a RESTful API that is used by the frontend application and other services.
Most requests to the endpoints are authenticated and authorized by the [Auth-Service](./auth-service) to ensure that only authorized users have access to protected resources.
The current user session is also integrated into the request context and the result set is filtered according to the user.

### Features

- **RESTful API** for providing data and business logic
- **Processing of Recurring Payments** using a job
- **Attachments**: Upload and manage file attachments for transactions

#### Jobs

##### `process-recurring-payments`

Scheduled at: `30 1 * * *` (daily at 01:30 AM) in the timezone `Europe/Berlin`.

This job processes due recurring payments and creates corresponding transactions. It also takes into account months with fewer than 31 days by executing payments for non-existent calendar days at the end of the month. Paused payments are skipped and the entire process is logged.

## Architecture

### Technologies

- **Framework**: [Express.js](https://github.com/expressjs/express)
- **Language**: [TypeScript](https://github.com/microsoft/TypeScript)
- **Database**: [PostgreSQL](https://github.com/postgres/postgres)
- **Cache**: [Redis](https://github.com/redis/redis)
- **ORM**: [Drizzle Kit](https://orm.drizzle.team/)

### Structure

Explain briefly the folder structure or important modules of the service.

```txt
src/
├── db/        # Contains database models and adapters to access the database
├── jobs/        # Contains functions for background jobs
├── lib/        # Contains library functions and initializations
├── middleware/        # Contains Express middleware functions
├── models/        # Providing classes and interfaces
├── types/        # Providing types and
├── config.ts        # Configuration file for the service
├── server.ts        # Main entry point of the application
```

### API Documentation

| Method | Path | Description |
| :--- | :--- | :--- |
| GET | `/health` | Health Check Endpoint |

## Development

**Start service locally**

```bash
# Install dependencies
npm install

# Copy environment variables
cp .env.example .env

# Start in development mode
npm run dev
```

**Linting & Formatting**

```bash
# Check linter
npm run check

# Automatically fix linter errors
npm run check:write

# Format code
npm run format
```

### Configuration

#### Environment Variables

| Variable | Description | Default Value |
| :--- | :--- | :--- |
| `NODE_ENV` | Execution environment (development, production, test) | `development` |
| `DATABASE_URL` | Connection string to the database | - |
| `REDIS_URL` | Connection string for Redis cache | - |
| `REDIS_DB` | Index of the Redis database | `1` |
| `TRUSTED_ORIGINS` | Comma-separated list of trusted origins for CORS | - |
| `AUTH_SERVICE_HOST` | Host URL under which the Auth Service is reachable | - |
| `LOG_LEVEL` | Log level for the application | `info` |
| `LOG_HIDE_META` | Whether to hide metadata in logs | `false` |
| `TIMEZONE` | Timezone for the application (for scheduling jobs) | `Europe/Berlin` |
| `PORT` | Port on which the service runs | `9000` |
| `LOKI_URL` | URL for the Loki logging service | `http://loki:3100` |
| `TEMPO_URL` | Ingest URL for the Tempo tracing service | `http://tempo:4318` |

<Callout type="info" title="Logs & Traces">
  The environment variable `TEMPO_URL` is only required if the server is started with tracing functionality (via instrumentation.js or `npm run start:instrumentation`) and logs are to be transmitted.
  If the environment variable `LOKI_URL` is not set, logs will be output "locally" to the console.
</Callout>

#### Object Store

Es wird ein S3-kompatibler Object Store für das Speichern von Dateianhängen verwendet. Jedem Attachment wird eine UUID v7 zugewiesen unter welcher die Datei im Object Store gespeichert wird und in der Datenbank referenziert wird.
Benutzer sind nur in der Lage Attachments abzurufen und zu löschen, die sie selbst hochgeladen haben.

Mehr Informationen über den gewählten Object Store können in der Dokumentation gefunden werden:
- [Railway Object Store](https://docs.railway.com/guides/storage-buckets)

> Serving and Uploading Files
> Buckets are private, but you can still work with their files in a few ways. You can serve files straight from the bucket, proxy them through your backend, or upload files directly from clients or services.
> Bucket egress is free. Service egress is not. If your service sends data to users or uploads files to a bucket, that traffic counts as service egress. The sections below explain these patterns and how to avoid unnecessary egress.

Die Dateien werden über das Backend als Proxy zwischen Object Store und Client bereitgestellt.

**Struktur der Keys im Bucket:**
```
avatars/:userId/<UUID_V7>-<originalFileName>
attachments/:userId/transactions/:transactionId/<UUID_V7>-<originalFileName>
```

**API Endpunkte für Attachments:**

| Methode | Pfad | Beschreibung |
| :--- | :--- | :--- |
| `GET` | `/api/attachment` | Ruft alle Attachments des authentifizierten Benutzers ab. |
| `GET` | `/api/attachment/:attachmentId` | Ruft ein spezifisches Attachment ab. Die `attachmentId` ist der Base64-URL-kodierte Key der Datei. |
| `POST` | `/api/attachment` | Lädt neue Attachments hoch. Erwartet `multipart/form-data` mit `files` (Dateien) und `transactionId` (Body). |
| `DELETE` | `/api/attachment` | Löscht Attachments. Erwartet ein JSON-Array von `attachmentIds` im Body. |

### Database Migrations

<Callout type="info">
  The environment variable `DATABASE_URL` must be set for migrations to be executed.
</Callout>

Database migrations are managed using Drizzle Kit. To create a new migration (for the database), the following command can be used:

```bash
npm run db:generate
```

Using the following command, the migrations can be applied to the database:

```bash
npm run db:migrate
```

## Deployment

Information about the deployment process (e.g. Docker, CI/CD Pipelines).

### Docker

The service can be containerized and deployed using the Dockerfile in the repository.
The following command can be used for this:

```bash
docker pull ghcr.io/budgetbuddyde/backend:latest
docker run -d -p 9000:9000 --env-file ./path/to/env/file ghcr.io/budgetbuddyde/backend:latest
```

Additionally, a `docker-compose.yml` file is available in the repository, which can be used to start the service locally together with a PostgreSQL and Redis instance.

### Railway

import RailwayDeployment from "../../../src/components/RailwayDeployment";

<RailwayDeployment />

## Dependencies

The Auth Service uses the following internal packages:

- [`@budgetbuddyde/logger`](/docs/packages/logger)
- [`@budgetbuddyde/types`](/docs/packages/types)
- [`@budgetbuddyde/utils`](/docs/packages/utils)

and requires the following external services:

- [Resend](https://resend.com/) for sending emails