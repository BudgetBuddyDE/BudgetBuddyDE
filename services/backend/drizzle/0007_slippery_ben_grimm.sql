DROP VIEW "budgetbuddy_backend"."spending_goal_view";--> statement-breakpoint
DROP VIEW "budgetbuddy_backend"."transaction_history_summary_view";--> statement-breakpoint
DROP VIEW "budgetbuddy_backend"."transaction_history_view";--> statement-breakpoint
CREATE VIEW "budgetbuddy_backend"."spending_goal_view" AS (select EXTRACT(MONTH FROM "budgetbuddy_backend"."transaction"."processed_at") as "month", EXTRACT(YEAR FROM "budgetbuddy_backend"."transaction"."processed_at") as "year", (DATE_TRUNC('month', "budgetbuddy_backend"."transaction"."processed_at") + INTERVAL '1 month - 1 day')::DATE as "date", "budgetbuddy_backend"."budget_category"."budget_id", "budgetbuddy_backend"."budget"."owner_id", "budgetbuddy_backend"."budget"."budget", COALESCE(SUM(CASE WHEN "budgetbuddy_backend"."transaction"."transfer_amount" < 0 THEN ABS("budgetbuddy_backend"."transaction"."transfer_amount") ELSE 0 END), 0) as "spending_so_far" from "budgetbuddy_backend"."budget" inner join "budgetbuddy_backend"."budget_category" on "budgetbuddy_backend"."budget_category"."budget_id" = "budgetbuddy_backend"."budget"."budget_id" left join "budgetbuddy_backend"."transaction" on "budgetbuddy_backend"."transaction"."category_id" = "budgetbuddy_backend"."budget_category"."category_id" AND "budgetbuddy_backend"."transaction"."owner_id" = "budgetbuddy_backend"."budget"."owner_id" group by EXTRACT(MONTH FROM "budgetbuddy_backend"."transaction"."processed_at"), EXTRACT(YEAR FROM "budgetbuddy_backend"."transaction"."processed_at"), (DATE_TRUNC('month', "budgetbuddy_backend"."transaction"."processed_at") + INTERVAL '1 month - 1 day')::DATE, "budgetbuddy_backend"."budget_category"."budget_id", "budgetbuddy_backend"."budget"."owner_id", "budgetbuddy_backend"."budget"."budget");--> statement-breakpoint
CREATE VIEW "budgetbuddy_backend"."transaction_history_summary_view" AS (select EXTRACT(MONTH FROM "processed_at") as "month", EXTRACT(YEAR FROM "processed_at") as "year", (DATE_TRUNC('month', "processed_at") + INTERVAL '1 month - 1 day')::DATE as "date", "owner_id", SUM(CASE WHEN "transfer_amount" > 0 THEN "transfer_amount" ELSE 0 END) as "income", SUM(CASE WHEN "transfer_amount" < 0 THEN ABS("transfer_amount") ELSE 0 END) as "expenses", SUM("transfer_amount") as "balance" from "budgetbuddy_backend"."transaction" group by EXTRACT(MONTH FROM "budgetbuddy_backend"."transaction"."processed_at"), EXTRACT(YEAR FROM "budgetbuddy_backend"."transaction"."processed_at"), (DATE_TRUNC('month', "budgetbuddy_backend"."transaction"."processed_at") + INTERVAL '1 month - 1 day')::DATE, "budgetbuddy_backend"."transaction"."owner_id");--> statement-breakpoint
CREATE VIEW "budgetbuddy_backend"."transaction_history_view" AS (select EXTRACT(MONTH FROM "processed_at") as "month", EXTRACT(YEAR FROM "processed_at") as "year", (DATE_TRUNC('month', "processed_at") + INTERVAL '1 month - 1 day')::DATE as "date", "owner_id", "category_id", SUM(CASE WHEN "transfer_amount" > 0 THEN "transfer_amount" ELSE 0 END) as "income", SUM(CASE WHEN "transfer_amount" < 0 THEN ABS("transfer_amount") ELSE 0 END) as "expenses", SUM("transfer_amount") as "balance" from "budgetbuddy_backend"."transaction" group by EXTRACT(MONTH FROM "budgetbuddy_backend"."transaction"."processed_at"), EXTRACT(YEAR FROM "budgetbuddy_backend"."transaction"."processed_at"), (DATE_TRUNC('month', "budgetbuddy_backend"."transaction"."processed_at") + INTERVAL '1 month - 1 day')::DATE, "budgetbuddy_backend"."transaction"."owner_id", "budgetbuddy_backend"."transaction"."category_id");